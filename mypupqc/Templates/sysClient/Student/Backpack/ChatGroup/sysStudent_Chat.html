{% extends 'layout/sysStudent/sysStudent_layout.html' %}

{% load static %}
{% load i18n %}

{% block title %}Chat - Apps{% endblock %}

{% block vendor_css %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'vendor/libs/bootstrap-maxlength/bootstrap-maxlength.css' %}" />

<link rel="stylesheet" href="{% static 'vendor/libs/animate-css/animate.css' %}" />
<link rel="stylesheet" href="{% static 'vendor/libs/sweetalert2/sweetalert2.css' %}" />
{% endblock vendor_css %}

{% block vendor_js %}
{{ block.super }}
<script src="{% static 'vendor/libs/bootstrap-maxlength/bootstrap-maxlength.js' %}"></script>

<script src="{% static 'vendor/libs/sweetalert2/sweetalert2.js' %}"></script>
{% endblock vendor_js %}

{% block page_css %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'vendor/css/pages/app-chat.css' %}" />

<link rel="stylesheet" href="{% static 'myClient/css/student/communitychatpage/chat/chat_page.css' %}" />
{% endblock page_css %}

{% block page_js %}
{{ block.super }}
<script src="{% static 'myClient/js/student/app-chat.js' %}"></script>


<!-- Begin: Community Chat Page Modals || Note: Not working as intended -->
{% comment %} <script>
  // expose any template‐computed URLs or config to your JS
  window.CHAT = {
    meAvatarUrl: "{% static 'img/avatars/1.png' %}"
  };
</script>
<script src="{% static 'myClient/js/student/communitychatpage/chat/chat_page.js' %}"></script> {% endcomment %}
<!-- Ending: Community Chat Page Modals || Note: Not working as intended -->
{% endblock page_js %}

{% block content %}
  <a href="{% url 'sys-student-StudentChatGroup' %}" class="btn btn-label-primary mb-3" style="font-size: 14px;">
    <span class="mdi mdi-arrow-left"></span> Back to Community Chats
  </a>

  <!-- Begin: Community Chat Page -->
  <!-- Begin: Wrapper Card -->
  <div class="app-chat card overflow-hidden" style="" >
    <div class="row g-0">

      <!-- Begin: Sidebar-Left (Community Info) -->
      <div class="col app-chat-sidebar-left app-sidebar overflow-hidden" id="app-chat-sidebar-left">
        <!-- Begin: Cover + Avatar -->
        <div class="sidebar-header position-relative p-0">
          <img id="commCover" class="w-100" style="height:120px;object-fit:cover;"
              src="{% static 'img/myPUPQC-Client/student/chats/commits.jpg' %}" alt="cover">
          <div class="position-absolute start-0 translate-middle-y ms-4" style="top:84px;">
            <div class="avatar avatar-xl">
              <img id="commAvatar" class="rounded-circle"
                  src="{% static 'img/myPUPQC-Client/student/chats/commits.jpg' %}" alt="avatar">
            </div>
          </div>
          <i class="mdi mdi-close mdi-20px cursor-pointer position-absolute top-0 end-0 m-2 d-lg-none"
            data-bs-toggle="sidebar" data-overlay data-target="#app-chat-sidebar-left"></i>
        </div>
        <!-- End: Cover + Avatar -->

        <!-- Begin: Sidebar-Body -->
        <div class="sidebar-body px-4 pt-5 pb-4 text-center">
          <h5 id="commName" class="fw-semibold mb-1">Junior Marketing Society</h5>
          <span id="commTags" class="text-muted small d-block mb-3">Marketing • Workshops • Networking</span>

          <p id="commDesc" class="small text-muted">
            Connect with fellow marketing enthusiasts and share innovative ideas. Join our workshops and networking events.
          </p>

          <div class="my-4">
            <p class="text-uppercase fw-medium mb-2">Notifications</p>
            <label class="switch switch-primary switch-sm">
              <input type="checkbox" class="switch-input" checked>
              <span class="switch-toggle-slider"><span class="switch-on"></span><span class="switch-off"></span></span>
            </label>
          </div>

          <button class="btn btn-outline-danger w-100" data-bs-toggle="modal" data-bs-target="#confirmLeaveModal">
            <i class="mdi mdi-logout me-1"></i> Leave Community
          </button>
        </div>
        <!-- End: Sidebar-Body -->
      </div>
      <!-- End: Sidebar-Left -->

      <!-- Begin: Sidebar-Contacts (Communities) -->
      <div class="col app-chat-contacts app-sidebar flex-grow-0 overflow-hidden border-end" id="app-chat-contacts">
        <div class="sidebar-header py-3 px-4 border-bottom">
          <div class="d-flex align-items-center w-100">
            <!-- Toggle Button -->
            <div class="flex-shrink-0 avatar avatar-online me-3" data-bs-toggle="sidebar" data-overlay="app-overlay-ex" data-target="#app-chat-sidebar-left-1">
              <img class="user-avatar rounded-circle cursor-pointer" src="{% static 'img/avatars/1.png' %}" alt="Avatar">
            </div>
            <!-- Sidebar Left -->
            <div class="col app-chat-sidebar-left app-sidebar overflow-hidden" id="app-chat-sidebar-left-1">
              <div class="chat-sidebar-left-user sidebar-header d-flex flex-column justify-content-center align-items-center flex-wrap px-4 pt-5">
                <div class="avatar avatar-xl avatar-online w-px-75 h-px-75">
                  <img src="{% static 'img/avatars/1.png' %}" alt="Avatar" class="rounded-circle">
                </div>
                <h5 class="mt-3 mb-1">John Doe</h5>
                <span>Student</span>
                <i class="mdi mdi-close mdi-20px cursor-pointer close-sidebar"
                  data-bs-toggle="sidebar"
                  data-overlay
                  data-target="#app-chat-sidebar-left-1"></i>
              </div>
              <div class="sidebar-body px-4 pb-4">
                {% comment %} <div class="mt-4 mb-3 pt-2">
                  <label for="chat-sidebar-left-user-about-1" class="text-uppercase fw-medium">About</label>
                  <textarea id="chat-sidebar-left-user-about-1"
                            class="form-control chat-sidebar-left-user-about mt-3"
                            rows="3" maxlength="120">Dessert chocolate cake lemon drops jujubes.</textarea>
                </div> {% endcomment %}
                <div class="my-3">
                  <p class="text-uppercase fw-medium">Status</p>
                  <div class="d-grid gap-1">
                    <div class="form-check form-check-success">
                      <input name="chat-user-status-1" class="form-check-input"
                            type="radio" value="active" id="user-active-1" checked>
                      <label class="form-check-label" for="user-active-1">Active</label>
                    </div>
                    <div class="form-check form-check-danger">
                      <input name="chat-user-status-1" class="form-check-input"
                            type="radio" value="busy" id="user-busy-1">
                      <label class="form-check-label" for="user-busy-1">Busy</label>
                    </div>
                    <div class="form-check form-check-warning">
                      <input name="chat-user-status-1" class="form-check-input"
                            type="radio" value="away" id="user-away-1">
                      <label class="form-check-label" for="user-away-1">Away</label>
                    </div>
                    <div class="form-check form-check-secondary">
                      <input name="chat-user-status-1" class="form-check-input"
                            type="radio" value="offline" id="user-offline-1">
                      <label class="form-check-label" for="user-offline-1">Offline</label>
                    </div>
                  </div>
                </div>
                <div class="my-3">
                  <p class="text-uppercase fw-medium">Settings</p>
                  <ul class="list-unstyled d-grid gap-2 me-3">
                    <li class="d-flex justify-content-between align-items-center">
                      <div>
                        <i class="mdi mdi-bell-outline me-1 mdi-24px"></i>
                        <span class="align-middle">Notification</span>
                      </div>
                      <label class="switch switch-primary me-4 switch-sm">
                        <input type="checkbox" class="switch-input" />
                        <span class="switch-toggle-slider">
                          <span class="switch-on"></span>
                          <span class="switch-off"></span>
                        </span>
                      </label>
                    </li>
                  </ul>
                </div>
              </div>
            </div>
            <!-- /Sidebar Left -->

            <div class="flex-grow-1 input-group input-group-merge rounded-pill">
              <span class="input-group-text"><i class="mdi mdi-magnify lh-1 mdi-24px"></i></span>
              <input type="text" class="form-control chat-search-input" placeholder="Search community…">
            </div>
          </div>
          <i class="mdi mdi-close mdi-20px cursor-pointer position-absolute top-0 end-0 mt-2 me-2 fs-4 d-lg-none"
            data-overlay data-bs-toggle="sidebar" data-target="#app-chat-contacts"></i>
        </div>

        <div class="sidebar-body">
          <ul class="list-unstyled chat-contact-list" id="community-list">

            <li class="chat-contact-list-item chat-contact-list-item-title">
              <h5 class="text-primary mb-0">Your Communities</h5>
            </li>

            <!-- BEGIN #noResult -->
            <div id="noResult" class="col-12 d-none">
              <div class="d-flex justify-content-center align-items-center text-center w-100 py-5" style="min-height:300px;">
                <div>
                  <svg width="90" height="90" class="mb-3" viewBox="0 0 24 24" fill="none">
                    <circle cx="10.5" cy="10.5" r="7.5" stroke="#ffc107" stroke-width="3"/>
                    <line x1="15.5" y1="15.5" x2="21" y2="21" stroke="#6c757d" stroke-width="3" stroke-linecap="round"/>
                  </svg>
                  <h6 class="mb-1 text-small">
                    Sorry, we couldn't find any matches for
                    <span id="noTerm" class="fw-semibold text-dark"></span>
                  </h6>
                  <p class="text-small mb-0">Please try searching with another community name</p>
                </div>
              </div>
            </div>
            <!-- END #noResult -->

            <!-- Junior Marketing Society -->
            <li class="chat-contact-list-item community-item active"
                data-name="Junior Marketing Society"
                data-tags="Marketing • Workshops • Networking"
                data-desc="Connect with fellow marketing enthusiasts and share innovative ideas. Join our workshops and networking events."
                data-members="150"
                data-cover="{% static 'img/myPUPQC-Client/student/chats/commits.jpg' %}"
                data-avatar="{% static 'img/myPUPQC-Client/student/chats/commits.jpg' %}">
              <a class="d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center flex-grow-1">
                  <div class="flex-shrink-0 avatar cursor-pointer"
                      data-bs-toggle="sidebar" data-overlay data-target="#app-chat-sidebar-left">
                    <img src="{% static 'img/myPUPQC-Client/student/chats/commits.jpg' %}"
                        class="rounded-circle" style="width:40px;height:40px;object-fit:cover;">
                  </div>
                  <div class="chat-contact-info flex-grow-1 ms-3">
                    <h6 class="chat-contact-name m-0">Junior Marketing Society</h6>
                    <p class="chat-contact-status text-truncate mb-0 small">150 members</p>
                  </div>
                </div>
                <small class="last-msg-time text-muted small"> </small>
              </a>
            </li>

            <!-- PUPQC Sports Club -->
            <li class="chat-contact-list-item community-item"
                data-name="PUPQC Sports Club"
                data-tags="Sports • Fitness"
                data-desc="Engage with active members who love sports and fitness. Discuss upcoming events, training sessions, and matches."
                data-members="120"
                data-cover="{% static 'img/myPUPQC-Client/student/chats/chrs.png' %}"
                data-avatar="{% static 'img/myPUPQC-Client/student/chats/chrs.png' %}">
              <a class="d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center flex-grow-1">
                  <div class="flex-shrink-0 avatar cursor-pointer"
                      data-bs-toggle="sidebar" data-overlay data-target="#app-chat-sidebar-left">
                    <img src="{% static 'img/myPUPQC-Client/student/chats/chrs.png' %}"
                        class="rounded-circle" style="width:40px;height:40px;object-fit:cover;">
                  </div>
                  <div class="chat-contact-info flex-grow-1 ms-3">
                    <h6 class="chat-contact-name m-0">PUPQC Sports Club</h6>
                    <p class="chat-contact-status text-truncate mb-0 small">120 members</p>
                  </div>
                </div>
                <small class="last-msg-time text-muted small"></small>
              </a>
            </li>

            <!-- Commonwealth Information Technology Society -->
            <li class="chat-contact-list-item community-item"
                data-name="Commonwealth Information Technology Society"
                data-tags="IT • Technology"
                data-desc="Discuss cutting-edge technology trends and share IT knowledge. Collaborate on projects and innovative solutions."
                data-members="75"
                data-cover="{% static 'img/myPUPQC-Client/student/chats/Vox Nova.png' %}"
                data-avatar="{% static 'img/myPUPQC-Client/student/chats/Vox Nova.png' %}">
              <a class="d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center flex-grow-1">
                  <div class="flex-shrink-0 avatar cursor-pointer"
                      data-bs-toggle="sidebar" data-overlay data-target="#app-chat-sidebar-left">
                    <img src="{% static 'img/myPUPQC-Client/student/chats/Vox Nova.png' %}"
                        class="rounded-circle" style="width:40px;height:40px;object-fit:cover;">
                  </div>
                  <div class="chat-contact-info flex-grow-1 ms-3">
                    <h6 class="chat-contact-name m-0">Comm IT Society</h6>
                    <p class="chat-contact-status text-truncate mb-0 small">75 members</p>
                  </div>
                </div>
                <small class="last-msg-time text-muted small"></small>
              </a>
            </li>

            <!-- Community of Human Resource Students -->
            <li class="chat-contact-list-item community-item"
                data-name="Community of Human Resource Students"
                data-tags="HR • Career"
                data-desc="Network with peers in human resources and learn best practices. Participate in seminars and career-building events."
                data-members="200"
                data-cover="{% static 'img/myPUPQC-Client/student/chats/sportsclub.png' %}"
                data-avatar="{% static 'img/myPUPQC-Client/student/chats/sportsclub.png' %}">
              <a class="d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center flex-grow-1">
                  <div class="flex-shrink-0 avatar cursor-pointer"
                      data-bs-toggle="sidebar" data-overlay data-target="#app-chat-sidebar-left">
                    <img src="{% static 'img/myPUPQC-Client/student/chats/sportsclub.png' %}"
                        class="rounded-circle" style="width:40px;height:40px;object-fit:cover;">
                  </div>
                  <div class="chat-contact-info flex-grow-1 ms-3">
                    <h6 class="chat-contact-name m-0">HR Students</h6>
                    <p class="chat-contact-status text-truncate mb-0 small">200 members</p>
                  </div>
                </div>
                <small class="last-msg-time text-muted small"></small>
              </a>
            </li>

            <!-- Youth Entrepreneurs Society - PUPQC -->
            <li class="chat-contact-list-item community-item"
                data-name="Youth Entrepreneurs Society - PUPQC"
                data-tags="Entrepreneurship • Business"
                data-desc="Empowering young entrepreneurs to innovate and lead. Share business ideas and gain valuable mentorship."
                data-members="95"
                data-cover="{% static 'img/myPUPQC-Client/student/chats/yes.png' %}"
                data-avatar="{% static 'img/myPUPQC-Client/student/chats/yes.png' %}">
              <a class="d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center flex-grow-1">
                  <div class="flex-shrink-0 avatar cursor-pointer"
                      data-bs-toggle="sidebar" data-overlay data-target="#app-chat-sidebar-left">
                    <img src="{% static 'img/myPUPQC-Client/student/chats/yes.png' %}"
                        class="rounded-circle" style="width:40px;height:40px;object-fit:cover;">
                  </div>
                  <div class="chat-contact-info flex-grow-1 ms-3">
                    <h6 class="chat-contact-name m-0">YES - PUPQC</h6>
                    <p class="chat-contact-status text-truncate mb-0 small">95 members</p>
                  </div>
                </div>
                <small class="last-msg-time text-muted small"></small>
              </a>
            </li>

          </ul>
        </div>
      </div>
      <!-- End: Sidebar-Contacts -->

      <!-- Begin: Chat-History -->
      <div class="col app-chat-history">
        <div class="chat-history-wrapper">

          <div class="chat-history-header border-bottom">
            <div class="d-flex justify-content-between align-items-center">
              <div class="d-flex align-items-center overflow-hidden">
                <i class="mdi mdi-menu mdi-24px cursor-pointer d-lg-none me-3"
                  data-bs-toggle="sidebar" data-overlay data-target="#app-chat-contacts"></i>

                <!-- avatar toggles info-sidebar -->
                <div class="avatar me-3">
                  <img id="headerAvatar" class="rounded-circle cursor-pointer"
                      data-bs-toggle="sidebar" data-overlay data-target="#app-chat-sidebar-left"
                      src="{% static 'img/myPUPQC-Client/student/chats/commits.jpg' %}"
                      style="width:40px;height:40px;object-fit:cover;">
                </div>

                <!-- Chat/Portal Header -->
                <div class="chat-contact-info">
                  <h6 id="headerName" class="m-0">Junior Marketing Society</h6>

                  <!-- Begin: headerMembers trigger -->
                  <span id="headerMembers"
                        class="small text-muted cursor-pointer"
                        data-bs-toggle="modal"
                        data-bs-target="#membersModal">
                    150 members
                  </span>
                  <!-- End: headerMembers trigger -->

                </div>
              </div>

              <!-- Begin: Header Dropdown -->
              <div class="dropdown">
                <button class="btn btn-icon btn-text-secondary rounded-pill dropdown-toggle hide-arrow"
                        data-bs-toggle="dropdown"><i class="mdi mdi-dots-vertical mdi-24px"></i></button>
                <div class="dropdown-menu dropdown-menu-end shadow-sm">
                  <!-- Begin: Settings trigger (opens multi-step modal) -->
                  <a class="dropdown-item d-flex align-items-center"
                    data-bs-toggle="modal"
                    data-bs-target="#settingschatModal">
                    <i class="mdi mdi-cog-outline me-2 text-primary"></i> Settings
                  </a>
                  <!-- End: Settings trigger -->

                  <a class="dropdown-item d-flex align-items-center view-info-btn"
                    data-bs-toggle="modal" data-bs-target="#viewCommunityModal">
                    <i class="mdi mdi-information-outline me-2 text-primary"></i> View Info
                  </a>
                  <a class="dropdown-item d-flex align-items-center" href="#"><i class="mdi mdi-bell-off-outline me-2"></i>Mute</a>
                  <hr class="dropdown-divider">
                  <a class="dropdown-item d-flex align-items-center text-danger clear-chat-btn" href="#"><i class="mdi mdi-delete-outline me-2"></i>Clear Chat</a>
                </div>
              </div>
              <!-- End: Header Dropdown -->
            </div>
          </div>

          <div class="chat-history-body" style="height: 550px;">
            <ul class="list-unstyled chat-history" id="messageList">
              <li class="chat-message chat-message-right placeholder-msg">

              </li>
            </ul>
          </div>

          <!-- Begin: Chat Footer -->
          <div class="chat-history-footer m-3">
            <form class="form-send-message d-flex align-items-center">
              <input id="msgInput" class="form-control message-input me-3" placeholder="Message #jms">
              <div class="d-flex align-items-center">
                <label class="mb-0 me-2"><i class="mdi mdi-paperclip mdi-20px cursor-pointer btn btn-text-secondary btn-icon"></i><input type="file" hidden></label>
                <button class="btn btn-primary">Send</button>
              </div>
            </form>
          </div>
          <!-- End: Chat Footer -->

        </div>
      </div>
      <!-- End: Chat-History -->

      <div class="app-overlay"></div>
    </div>
  </div>
  <!-- End: Wrapper Card -->
  <!-- End: Community Chat Page -->


  <!-- Begin: Chat Scripts (with “time ago” + Mute + Auto-Scroll) -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      /* ──────────────────────────────────────────────────────────────
        HELPERS & STATE
      ────────────────────────────────────────────────────────────── */
      const unreadCounts = {};
      const mutedRooms   = new Set();
      const GAP_MS       = 20 * 60 * 1000;
      const slug         = s => s.toLowerCase().replace(/[^a-z0-9]+/g,'-');
      const meAvatar     = '{% static "img/avatars/1.png" %}';
      window.leftCommunities = window.leftCommunities || {};

      function nowISO() {
        return new Date().toISOString().replace(/\.\d+Z$/, 'Z');
      }
      function toAmPm(d) {
        const yyyy = d.getFullYear(),
              MM   = String(d.getMonth()+1).padStart(2,'0'),
              dd   = String(d.getDate()).padStart(2,'0'),
              hh24 = d.getHours(),
              ampm = hh24 >= 12 ? 'PM' : 'AM',
              hh   = String((hh24 % 12) || 12).padStart(2,'0'),
              mi   = String(d.getMinutes()).padStart(2,'0');
        return `${yyyy}-${MM}-${dd} ${hh}:${mi} ${ampm}`;
      }
      function timeAgo(d) {
        const sec = Math.floor((Date.now() - d.getTime()) / 1000);
        if (sec < 5)   return 'just now';
        if (sec < 60)  return sec + 's ago';
        const min = Math.floor(sec / 60);
        if (min < 60)  return min + 'm ago';
        const hr = Math.floor(min / 60);
        if (hr < 24)   return hr + 'h ago';
        return Math.floor(hr / 24) + 'd ago';
      }

      /* ──────────────────────────────────────────────────────────────
        AUTO-SCROLL HELPERS
      ────────────────────────────────────────────────────────────── */
      const chatBody = document.querySelector('.chat-history-body');
      function scrollToBottom() {
        chatBody.scrollTop = chatBody.scrollHeight;
      }

      /* ──────────────────────────────────────────────────────────────
        MUTE MENU LOGIC
      ────────────────────────────────────────────────────────────── */
      const muteMenuItem = Array.from(
        document.querySelectorAll('.dropdown-menu .dropdown-item')
      ).find(a => a.textContent.trim().startsWith('Mute'));

      if (muteMenuItem) {
        muteMenuItem.addEventListener('click', e => {
          e.preventDefault();
          if (!currentRoom) return;
          if (mutedRooms.has(currentRoom)) mutedRooms.delete(currentRoom);
          else mutedRooms.add(currentRoom);
          updateMuteMenu();
          updateMuteIcon(currentRoom);
        });
      }

      function updateMuteMenu() {
        if (!muteMenuItem) return;
        const icon = muteMenuItem.querySelector('i');
        const txt  = muteMenuItem;
        if (mutedRooms.has(currentRoom)) {
          icon.classList.replace('mdi-bell-off-outline','mdi-bell-outline');
          txt.childNodes[1].textContent = ' Unmute';
        } else {
          icon.classList.replace('mdi-bell-outline','mdi-bell-off-outline');
          txt.childNodes[1].textContent = ' Mute';
        }
      }

      function updateMuteIcon(room) {
        const li = document.querySelector(`.community-item[data-slug="${room}"]`);
        if (!li) return;
        // remove any existing
        const prev = li.querySelector('.muted-icon');
        if (prev) prev.remove();
        if (mutedRooms.has(room)) {
          const icon = document.createElement('i');
          icon.className = 'mdi mdi-bell-off-outline text-muted ms-1 muted-icon';
          li.querySelector('a').appendChild(icon);
        }
      }

      /* ──────────────────────────────────────────────────────────────
        INITIAL “last-msg-time” ELEMENT
      ────────────────────────────────────────────────────────────── */
      document.querySelectorAll('.community-item').forEach(li => {
        li.dataset.slug = slug(li.dataset.name);
        const a = li.querySelector('a');
        const last = document.createElement('small');
        last.className = 'last-msg-time text-muted small';
        last.style.marginLeft = '0.5rem';
        a.appendChild(last);
      });

      function updateAllLastTimes() {
        Object.entries(chats).forEach(([room, msgs]) => {
          if (!msgs.length) return;
          const lastMsg = msgs[msgs.length - 1];
          const li      = document.querySelector(`.community-item[data-slug="${room}"]`);
          if (!li) return;
          const lbl = li.querySelector('.last-msg-time');
          lbl.textContent = timeAgo(new Date(lastMsg.time));
          updateMuteIcon(room);
        });
      }

      /* ──────────────────────────────────────────────────────────────
        BUMP & UNREAD HANDLING
      ────────────────────────────────────────────────────────────── */
      function moveLiToTop(li) {
        const list    = document.getElementById('community-list'),
              titleLi = list.querySelector('.chat-contact-list-item-title');
        list.insertBefore(li, titleLi.nextSibling);
      }
      function bumpCommunity(room) {
        const li = document.querySelector(`.community-item[data-slug="${room}"]`);
        if (!li) return;
        unreadCounts[room] = (unreadCounts[room]||0) + 1;
        let badge = li.querySelector('.unread-badge');
        if (!badge) {
          badge = document.createElement('span');
          badge.className = 'badge bg-danger ms-2 unread-badge';
          li.querySelector('.chat-contact-info').appendChild(badge);
        }
        badge.textContent = unreadCounts[room];
        moveLiToTop(li);
      }
      function moveCommunity(room) {
        const li = document.querySelector(`.community-item[data-slug="${room}"]`);
        if (li) moveLiToTop(li);
      }
      function clearUnread(room) {
        unreadCounts[room] = 0;
        const li = document.querySelector(`.community-item[data-slug="${room}"]`);
        if (!li) return;
        const b = li.querySelector('.unread-badge');
        if (b) b.remove();
      }

      /* ──────────────────────────────────────────────────────────────
        PATCH window.addSystemEvent
      ────────────────────────────────────────────────────────────── */
      const origAdd = window.addSystemEvent;
      window.addSystemEvent = (room, txt) => {
        origAdd(room, txt);
        if (room !== currentRoom) bumpCommunity(room);
        updateAllLastTimes();
      };
      document.querySelectorAll('.community-item').forEach(li => {
        li.addEventListener('click', () => clearUnread(li.dataset.slug));
      });

      /* ──────────────────────────────────────────────────────────────
        CHAT DATA & DOM REFS
      ────────────────────────────────────────────────────────────── */
      const initialChats = {
        'junior-marketing-society': [
          { user:'system', text:'Ben White joined.', time:'2025-04-29T09:58:00Z' },
          { user:'me', text:'Welcome! 🎉', time:'2025-04-29T10:00:00Z', avatar:meAvatar },
          { user:'Ben White', text:'Don’t forget tomorrow’s workshop!', time:'2025-04-29T10:02:00Z', avatar:'{% static "img/avatars/2.png" %}' }
        ],
        'dev-club': [
          { user:'me', text:'Stand-up in 5 minutes.', time:'2025-04-29T09:55:00Z', avatar:meAvatar },
          { user:'Evan Yu', text:'Roger that.', time:'2025-04-29T09:56:00Z', avatar:'{% static "img/avatars/5.png" %}' }
        ],
        'art-hub': [
          { user:'system', text:'Jamie joined.', time:'2025-04-28T18:28:00Z' },
          { user:'Jamie Chua', text:'Uploading mock-ups.', time:'2025-04-28T18:30:00Z', avatar:'{% static "img/avatars/3.png" %}' }
        ]
      };
      const chats = JSON.parse(JSON.stringify(initialChats));

      const list       = document.getElementById('community-list');
      const coverImg   = document.getElementById('commCover');
      const avatarL    = document.getElementById('commAvatar');
      const nameL      = document.getElementById('commName');
      const tagsL      = document.getElementById('commTags');
      const descL      = document.getElementById('commDesc');
      const headerAv   = document.getElementById('headerAvatar');
      const headerNm   = document.getElementById('headerName');
      const headerMem  = document.getElementById('headerMembers');
      const msgInput   = document.getElementById('msgInput');
      const msgList    = document.getElementById('messageList');
      const clearBtn   = document.querySelector('.clear-chat-btn');
      const sendForm   = document.querySelector('.form-send-message');
      const placeholderHTML = msgList.querySelector('.placeholder-msg').outerHTML;
      let   currentRoom = null;

      /* ──────────────────────────────────────────────────────────────
        RENDER & LOAD COMMUNITY
      ────────────────────────────────────────────────────────────── */
      function renderMessages(room) {
        const arr = chats[room]||[];
        if (!arr.length) {
          msgList.innerHTML = placeholderHTML;
          scrollToBottom();
          return;
        }
        let html = '', prev = null;
        arr.forEach(m => {
          const date = new Date(m.time);
          if (!prev || (date - prev) > GAP_MS) {
            html += `<li class="chat-divider text-center text-muted small my-2">${toAmPm(date)}</li>`;
          }
          prev = date;
          if (m.user==='system') {
            html += `<li class="chat-divider text-center text-muted small my-2">— ${m.text} —</li>`;
            return;
          }
          const me = m.user==='me';
          const side = me ? 'right' : 'left';
          const name = me ? '' : `<small class="text-primary">${m.user}</small>`;
          const avat = `<img src="${m.avatar}" class="rounded-circle">`;
          html += `
            <li class="chat-message chat-message-${side}">
              <div class="d-flex overflow-hidden">
                ${!me ? `<div class="user-avatar flex-shrink-0 me-3"><div class="avatar avatar-sm">${avat}</div></div>` : ''}
                <div class="chat-message-wrapper flex-grow-1">
                  ${name}
                  <div class="chat-message-text"><p class="mb-0">${m.text}</p></div>
                  <div class="${me?'text-end':''} text-muted small"><small class="msg-time">${toAmPm(date)}</small></div>
                </div>
                ${me ? `<div class="user-avatar flex-shrink-0 ms-3"><div class="avatar avatar-sm">${avat}</div></div>` : ''}
              </div>
            </li>`;
        });
        msgList.innerHTML = html;
        scrollToBottom();
      }

      function loadCommunity(li) {
        const d    = li.dataset,
              room = d.slug;
        list.querySelectorAll('.community-item').forEach(x=>x.classList.remove('active'));
        li.classList.add('active');
        coverImg.src        = d.cover;
        avatarL.src         = headerAv.src = d.avatar;
        nameL.textContent   = headerNm.textContent = d.name;
        tagsL.textContent   = d.tags;
        descL.textContent   = d.desc;
        headerMem.textContent = `${d.members} members`;
        msgInput.placeholder  = `Message #${room}`;
        document.querySelector('.chat-history-footer')
                .classList.toggle('d-none', !!window.leftCommunities?.[room]);
        currentRoom = room;

        renderMessages(room);
        updateAllLastTimes();
        updateMuteMenu();
      }

      document.querySelectorAll('.community-item')
              .forEach(li => li.addEventListener('click', () => loadCommunity(li)));
      loadCommunity(document.querySelector('.community-item.active'));

      /* ──────────────────────────────────────────────────────────────
        SENDING MY MESSAGE
      ────────────────────────────────────────────────────────────── */
      sendForm.addEventListener('submit', e => {
        e.preventDefault();
        if (window.leftCommunities?.[currentRoom]) return;
        const txt = msgInput.value.trim();
        if (!txt) return;
        chats[currentRoom] = chats[currentRoom]||[];
        chats[currentRoom].push({ user:'me', text:txt, time:nowISO(), avatar:meAvatar });
        renderMessages(currentRoom);
        msgInput.value = '';
        moveCommunity(currentRoom);
        updateAllLastTimes();
      });

      /* ──────────────────────────────────────────────────────────────
        CLEAR CHAT
      ────────────────────────────────────────────────────────────── */
      clearBtn.addEventListener('click', () => {
        chats[currentRoom] = [];
        renderMessages(currentRoom);
      });

      /* ──────────────────────────────────────────────────────────────
        SEARCH + NO-RESULT
      ────────────────────────────────────────────────────────────── */
      const searchInput    = document.querySelector('.chat-search-input');
      const communityItems = Array.from(document.querySelectorAll('.community-item'));
      const noResultDiv    = document.getElementById('noResult');
      const noTermSpan     = document.getElementById('noTerm');

      if (searchInput) {
        searchInput.addEventListener('input', e => {
          const term = e.target.value.toLowerCase().trim();
          let matches = 0;
          communityItems.forEach(item => {
            const txt = (item.dataset.name + ' ' + item.dataset.tags).toLowerCase();
            const ok  = !term || txt.includes(term);
            item.classList.toggle('d-none', !ok);
            if (ok) matches++;
          });
          if (!term || matches) {
            noResultDiv.classList.add('d-none');
          } else {
            noTermSpan.textContent = term;
            noResultDiv.classList.remove('d-none');
          }
        });
      }

      // refresh “time ago” every minute
      setInterval(updateAllLastTimes, 60*1000);

    });
  </script>
  <!-- End: Chat Scripts -->

  {% include 'sysClient/partials/student/community-chat/modal_view_info-chat.html' %}
  {% include 'sysClient/partials/student/community-chat/chatgroup/modal_view_member.html' %}

  {% include 'sysClient/partials/student/community-chat/chatgroup/modal_leaving_community.html' %}

  {% include 'sysClient/partials/student/community-chat/chatgroup/modal_edit_chat.html' %}

{% endblock %}
