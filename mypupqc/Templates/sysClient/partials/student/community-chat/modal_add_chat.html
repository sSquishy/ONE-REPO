<!-- ================================================================
     COMMUNITY CHAT  –  MULTI-STEP MODALS
     • STEP-1  Choose size of community
     • STEP-2  Name + Icon + Tags + Description
     • STEP-3  Cover upload + draggable preview
================================================================ -->

<!-- ================================================================
     FIRST MODAL  (STEP-1 + STEP-2)
================================================================ -->
<div class="modal fade" id="createPortalModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content portal-modal">

      <div class="modal-header border-0">
        <h5 class="modal-title w-100 text-center">Tell Us More About Your Community</h5>
        <button type="button" class="btn-close me-3" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <!-- STEP-1 -->
        <div class="step-content" id="step1">
          <p class="text-center description">
            In order to help you set up, is your new community chat for just a few users or a larger group?
          </p>
          <div class="d-grid gap-2 mb-3">
            <button type="button" class="btn option-btn d-flex justify-content-between align-items-center to-step2">
              <span><i class="bi bi-people-fill me-2"></i> For a smaller community</span>
              <i class="bi bi-chevron-right"></i>
            </button>
            <button type="button" class="btn option-btn d-flex justify-content-between align-items-center to-step2">
              <span><i class="bi bi-people-fill me-2"></i> For a department or organization</span>
              <i class="bi bi-chevron-right"></i>
            </button>
          </div>
          <p class="text-center small">
            Not sure? <a href="#" class="to-step2">You can skip this question for now.</a>
          </p>
          <div class="text-start mt-2">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Back</button>
          </div>
        </div>

        <!-- STEP-2 -->
        <div class="step-content d-none" id="step2">
          <p class="text-center description mb-4">
            Give your new community a name, icon, <strong>up&nbsp;to&nbsp;5&nbsp;tags</strong>, and an optional description&nbsp;(100&nbsp;chars).<br>
            Fields marked with * are required.
          </p>

          <!-- Icon upload (required) -->
          <div class="upload-area mx-auto mb-3" id="uploadArea">
            <label class="upload-label">
              <div class="upload-circle">
                <i class="bi bi-camera-fill upload-icon"></i>
                <div class="upload-text">UPLOAD*</div>
              </div>
            </label>
            <input type="file" id="portalIcon" accept="image/*" class="d-none" />
          </div>

          <!-- Name (required) -->
          <div class="mb-3 position-relative">
            <input type="text" id="portalName" class="form-control text-center"
                   placeholder="Enter portal name *" required />
            <div class="invalid-feedback">Please enter a portal name.</div>
          </div>

          <!-- Tags (required, max 5) -->
          <div class="col-md-12 mb-4">
            <div class="form-floating form-floating-outline">
              <input id="TagifyBasic" class="form-control h-auto" name="TagifyBasic" value="" placeholder="Add tags" />
              <label for="TagifyBasic">Tags * (max&nbsp;5)</label>
            </div>
          </div>

          <!-- Description (optional, 100 chars) -->
          <div class="col-md-12 mb-2">
            <div class="form-floating form-floating-outline">
              <textarea id="portalDescription" class="form-control h-auto"
                        placeholder="Enter portal description (optional, 100 chars max)"
                        maxlength="100" style="height: 100px;"></textarea>
              <label for="portalDescription">Description (optional)</label>
            </div>
            <div class="text-end small text-muted"><span id="descCounter">0</span>/100</div>
          </div>

          <small class="d-block text-center text-muted mb-3">
            By creating a community, you agree to myPUPQC’s
            <a href="#" class="link-primary">Community Guidelines</a>.
          </small>

          <div class="d-flex justify-content-between">
            <button type="button" class="btn btn-outline-secondary" id="toStep1Btn">Back</button>
            <button type="button" class="btn btn-primary" id="createPortalBtn">Next</button>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- ================================================================
     THIRD MODAL  (STEP-3 – Dropzone + draggable cover preview)
================================================================ -->
<div class="modal fade" id="communityBgModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered" style="max-width: 800px;">
    <div class="modal-content p-3 p-md-1">

      <div class="modal-body py-3 py-md-0">

        <!-- Modal Header -->
        <div class="modal-header">
          <h3 class="modal-title text-center w-100">Upload a Cover Image*</h3>
          <button type="button" class="btn-close" data-bs-dismiss="modal"
                  aria-label="Close" style="font-size: 1.5rem; width: 32px; height: 32px; padding-top: 10px;"></button>
        </div>

        <div class="text-center mb-4">
          <p class="pt-1">For best results, use at least 1920×1080&nbsp;px (JPG/PNG).</p>
        </div>

        <!-- Dropzone (required) -->
        <form action="/upload_community_cover"
              class="dropzone polished-dropzone"
              id="bg-dropzone">
          <div class="dz-message">
            <div class="dz-icon"><i class="bi bi-image"></i></div>
            <h5 class="dz-main-text mb-1">Drag and drop image files to upload</h5>
            <p class="dz-sub-text mb-3">Your cover will be private until you publish your community.</p>
            <button type="button" class="btn btn-outline-primary dz-select-btn">Select files</button>
          </div>
        </form>

        <!-- small thumbnail / progress -->
        <div id="bg-upload-preview" class="mt-4" style="display:none;">
          <div class="upload-item">
            <div class="upload-thumbnail">
              <img src="" alt="Preview" id="bg-uploaded-preview" />
            </div>
            <div class="upload-details">
              <div class="upload-header">
                <span class="upload-filename" id="bg-uploaded-filename"></span>
                <span class="upload-size"     id="bg-uploaded-size"></span>
              </div>
              <div class="upload-progress-container">
                <div class="upload-progress">
                  <div class="upload-progress-bar" style="width:0%"></div>
                </div>
                <span class="upload-percentage" id="bg-upload-percentage">0%</span>
                <span class="upload-remove" id="bg-remove-upload">×</span>
              </div>
            </div>
          </div>
        </div>

        <!-- full-width draggable cover preview -->
        <div id="bg-cover-preview" class="mt-3" style="display:none;">
          <img id="bg-cover-image" src="" alt="Cover preview"
               class="w-100 rounded"
               style="width:100%;height:300px;object-fit:cover;
                      object-position:50% 50%;cursor:grab;user-select:none;">
        </div>
        <br>
      </div>

      <!-- THIRD MODAL footer back (hides this modal, shows the first) -->
      <div class="modal-footer d-flex justify-content-between">
        <button type="button" class="btn btn-outline-secondary" id="bgBackBtn">Back</button>
        <button type="button" class="btn btn-primary" id="saveBgBtn" disabled>Finish</button>
      </div>

    </div>
  </div>
</div>

<!-- ================================================================
                               STYLES
================================================================ -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@yaireo/tagify@latest/dist/tagify.css">

<style>
  /* Ensure tag color uses dynamic variable */
  .tagify__tag {
    color: var(--tag-color, #fff) !important;
    border: none !important;
  }
  .tagify__tag > div,
  .tagify__tag .tagify__text {
    color: inherit !important;
  }

  /* invalid borders */
  .is-invalid-border{border:2px solid #dc3545!important;}

  /* KEEP YOUR ORIGINAL .upload-remove */
  .upload-remove{color:#dc3545;cursor:pointer;font-size:24px;line-height:1;margin-left:10px;}

  /* modal & text */
  .portal-modal{background:#fff;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,.15);}
  .modal-title{font-size:1.25rem;font-weight:600;}
  .description{color:#72767d;font-size:.95rem;}

  /* buttons / links */
  .option-btn{background:#f6f6f7;border:1px solid #e0e0e0;border-radius:4px;color:#2f3136;padding:.75rem 1rem;}
  .option-btn:hover{background:#f2f2f3;}
  .back-link{font-size:.9rem;color:#72767d;}
  .back-link:hover{text-decoration:underline;}
  .btn-primary{background:#5865f2;border:none;border-radius:4px;padding:.5rem 1.5rem;color:#fff;}
  .btn-primary:hover{background:#4752c4;}
  button:disabled{opacity:.65;cursor:not-allowed;}

  /* STEP-2 icon upload */
  .upload-area{width:96px;height:96px;border:2px dashed #ccc;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;}
  .upload-circle{text-align:center;}
  .upload-icon{font-size:24px;color:#72767d;}
  .upload-text{font-size:10px;color:#72767d;margin-top:4px;}
  .upload-wrapper{position:relative;width:96px;height:96px;border-radius:50%;overflow:hidden;}
  .upload-wrapper img{width:100%;height:100%;object-fit:cover;}

  /* dropzone */
  .polished-dropzone{border:2px dashed #0d6efd;border-radius:10px;min-height:260px;background:#fdfdff;display:flex;align-items:center;justify-content:center;transition:border-color .2s,background .2s;}
  .polished-dropzone.dz-drag-hover{border-color:#0b5ed7;background:#f0f7ff;}
  .polished-dropzone .dz-message{display:flex;flex-direction:column;align-items:center;text-align:center;cursor:pointer;}
  .dz-icon i{font-size:44px;color:#0d6efd;}
  .dz-main-text{font-weight:600;color:#000;}
  .dz-sub-text{font-size:13px;color:#6c757d;}
  .dz-select-btn{pointer-events:none;}

  /* upload item */
  .upload-item{display:flex;align-items:center;gap:15px;padding:12px;border:1px solid #e0e0e0;border-radius:8px;background:#f8f9fa;}
  .upload-thumbnail{width:80px;height:60px;border-radius:4px;overflow:hidden;}
  .upload-thumbnail img{width:100%;height:100%;object-fit:cover;}
  .upload-details{flex-grow:1;}
  .upload-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;}
  .upload-filename{font-size:14px;font-weight:500;}
  .upload-size{font-size:12px;color:#6c757d;}
  .upload-progress-container{display:flex;align-items:center;gap:10px;}
  .upload-progress{flex-grow:1;height:6px;background:#e9ecef;border-radius:4px;overflow:hidden;}
  .upload-progress-bar{height:100%;background:#0d6efd;transition:width .3s;}
  .upload-percentage{font-size:12px;color:#0d6efd;min-width:40px;text-align:right;}
</style>

<!-- ================================================================
                               SCRIPTS
================================================================ -->
<script src="https://cdn.jsdelivr.net/npm/@yaireo/tagify@latest/dist/tagify.min.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    /* ---------------- Tagify ---------------- */
    const tagifyInput = document.getElementById('TagifyBasic');
    let tagify = null, tagifyWrapper = null;
    if (tagifyInput) {
      tagify = new Tagify(tagifyInput, { maxTags: 5 });
      tagifyWrapper = tagify.DOM.scope;

      const clearTagError = () => tagifyWrapper.classList.remove('is-invalid-border');

      tagify.on('add', e => {
        /* random color */
        const tagElm = e.detail.tag;
        const bg = '#' + Math.floor(Math.random()*16777215).toString(16).padStart(6,'0');
        tagElm.style.setProperty('--tag-bg', bg, 'important');

        /* brightness check */
        const r=parseInt(bg.substr(1,2),16),
              g=parseInt(bg.substr(3,2),16),
              b=parseInt(bg.substr(5,2),16);
        const brightness=(r*299+g*587+b*114)/1000;
        const fontCol = brightness > 186 ? '#000000' : '#ffffff';
        tagElm.style.setProperty('--tag-color', fontCol, 'important');
        tagElm.style.color = fontCol;

        if(tagify.value.length > 5){
          tagify.removeTag(tagElm);
          Swal.fire({title:'Limit reached',text:'Only 5 tags allowed.',icon:'warning',timer:1500,showConfirmButton:false});
        }
        clearTagError();
      });

      tagify.on('remove', clearTagError);
    }

    /* ---- Description counter --- */
    const descTxt   = document.getElementById('portalDescription');
    const descCount = document.getElementById('descCounter');
    descTxt.addEventListener('input', ()=>{ descCount.textContent = descTxt.value.length; });

    /* ------------ Common refs -------------- */
    const step1       = document.getElementById('step1');
    const step2       = document.getElementById('step2');
    const to2Btns     = [...document.querySelectorAll('.to-step2')];
    const to1Btn      = document.getElementById('toStep1Btn');
    const modalEl     = document.getElementById('createPortalModal');
    const pm          = modalEl.querySelector('.portal-modal');
    // add a smooth height transition
    pm.style.transition = 'height 0.3s ease';

    const nameInput   = document.getElementById('portalName');
    const uploadArea  = document.getElementById('uploadArea');
    const iconInput   = document.getElementById('portalIcon');
    const createBtn   = document.getElementById('createPortalBtn');
    const mainModal   = new bootstrap.Modal(modalEl);

    const bgModalEl   = document.getElementById('communityBgModal');
    const bgModal     = new bootstrap.Modal(bgModalEl);
    const previewBox  = document.getElementById('bg-upload-preview');
    const bgImg       = document.getElementById('bg-uploaded-preview');
    const bgFileNm    = document.getElementById('bg-uploaded-filename');
    const bgFileSz    = document.getElementById('bg-uploaded-size');
    const bgPct       = document.getElementById('bg-upload-percentage');
    const bgBar       = previewBox.querySelector('.upload-progress-bar');
    const bgRemoveBtn = document.getElementById('bg-remove-upload');
    const saveBgBtn   = document.getElementById('saveBgBtn');
    const bgBackBtn   = document.getElementById('bgBackBtn');
    const coverBox    = document.getElementById('bg-cover-preview');
    const coverImg    = document.getElementById('bg-cover-image');

    /* ---------------- swap STEP ---------------- */
    function swap(a,b){
      const h1=a.offsetHeight;
      b.classList.remove('d-none'); b.style.position='absolute'; b.style.visibility='hidden';
      const h2=b.offsetHeight; b.style.position=''; b.style.visibility='';
      pm.style.height=h1+'px';
      requestAnimationFrame(()=>pm.style.height=h2+'px');
      pm.addEventListener('transitionend',function fn(){
        a.classList.add('d-none'); pm.style.height=''; pm.removeEventListener('transitionend',fn);
      });
    }
    to2Btns.forEach(btn=>btn.addEventListener('click',()=>swap(step1,step2)));
    to1Btn.addEventListener('click',()=>swap(step2,step1));

    /* ------------ icon upload --------------- */
    function initIcon(){
      uploadArea.classList.remove('is-invalid-border');
      uploadArea.innerHTML = `
        <label class="upload-label">
          <div class="upload-circle">
            <i class="bi bi-camera-fill upload-icon"></i>
            <div class="upload-text">UPLOAD*</div>
          </div>
        </label>`;
      uploadArea.onclick = ()=>iconInput.click();
    }
    initIcon();
    iconInput.addEventListener('change', ()=>{
      const f = iconInput.files[0];
      if (!f || !f.type.startsWith('image/')) return;
      uploadArea.classList.remove('is-invalid-border');
      const r = new FileReader();
      r.onload = e => {
        uploadArea.innerHTML = `
          <div class="upload-wrapper">
            <img src="${e.target.result}" alt="preview" />
            <div class="upload-remove">&times;</div>
          </div>`;
        const wrap = uploadArea.querySelector('.upload-wrapper');
        wrap.onclick = ()=> iconInput.click();
        uploadArea.querySelector('.upload-remove').onclick = ()=>{
          iconInput.value = ''; initIcon();
        };
      };
      r.readAsDataURL(f);
    });

    /* ----------- validation STEP-2 ---------- */
    function validateStep2(){
      let valid = true;
      if (!nameInput.value.trim()){
        nameInput.classList.add('is-invalid'); valid = false;
      } else nameInput.classList.remove('is-invalid');

      if (!iconInput.files.length){
        uploadArea.classList.add('is-invalid-border'); valid = false;
      } else uploadArea.classList.remove('is-invalid-border');

      if (!tagify || tagify.value.length === 0){
        tagifyWrapper.classList.add('is-invalid-border'); valid = false;
      } else tagifyWrapper.classList.remove('is-invalid-border');

      return valid;
    }

    /* --------- proceed to STEP-3 ------------ */
    createBtn.onclick = ()=>{
      if (!validateStep2()) return;
      const handler = ()=>{ bgModal.show(); modalEl.removeEventListener('hidden.bs.modal', handler); };
      modalEl.addEventListener('hidden.bs.modal', handler, { once: true });
      mainModal.hide();
    };
    nameInput.oninput = ()=> nameInput.classList.remove('is-invalid');

    /* ---- Dropzone & preview ---------------- */
    const fmt = b => `${(b/1024/1024).toFixed(1)} MB`;
    let bgFile = null, bgDone = false;
    const toggleFinish = ()=> saveBgBtn.disabled = !bgDone;

    const dz = new Dropzone('#bg-dropzone', {
      url: '/upload_community_cover',
      maxFiles: 1, maxFilesize: 5, acceptedFiles: 'image/jpeg,image/png',
      addRemoveLinks: false, autoProcessQueue: true, previewTemplate: '<div></div>',
      init(){
        this.on('addedfile', file => {
          previewBox.style.display = 'block';
          const reader = new FileReader();
          reader.onload = e => {
            bgImg.src    = e.target.result;
            coverImg.src = e.target.result;
            coverBox.style.display = 'block';
            coverImg.style.objectPosition = '50% 50%';
          };
          reader.readAsDataURL(file);
          bgFileNm.textContent = file.name;
          bgFileSz.textContent = fmt(file.size);
          bgBar.style.width = '0%'; bgPct.textContent = '0%';
          bgFile = file; bgDone = false; toggleFinish();
          document.querySelector('.polished-dropzone').classList.remove('is-invalid-border');
        });
        this.on('uploadprogress', (_f,p)=>{ bgBar.style.width = p+'%'; bgPct.textContent = Math.round(p)+'%'; });
        this.on('success', ()=>{
          bgBar.style.width = '100%'; bgPct.textContent = '100%';
          bgDone = true; toggleFinish();
          document.querySelector('.polished-dropzone').style.display = 'none';
        });
        this.on('removedfile', ()=>{ resetAllCover(); });
      }
    });

    /* ---------- draggable cover ---------- */
    let isDragging = false,
        startX, startY,
        startPosX, startPosY;

    coverImg.addEventListener('mousedown', e => {
      if (!coverBox.offsetParent) return;
      isDragging = true;
      coverImg.style.cursor = 'grabbing';
      startX = e.clientX; startY = e.clientY;
      const [pX, pY] = coverImg.style.objectPosition.split(' ');
      startPosX = parseFloat(pX); startPosY = parseFloat(pY);
      e.preventDefault();
    });

    document.addEventListener('mousemove', e => {
      if (!isDragging) return;
      const rect = coverBox.getBoundingClientRect();
      const dx   = (e.clientX - startX) / rect.width  * 100;
      const dy   = (e.clientY - startY) / rect.height * 100;
      let newX = Math.min(100, Math.max(0, startPosX - dx));
      let newY = Math.min(100, Math.max(0, startPosY - dy));
      coverImg.style.objectPosition = `${newX}% ${newY}%`;
    });

    document.addEventListener('mouseup', ()=> {
      if (isDragging) {
        isDragging = false;
        coverImg.style.cursor = 'grab';
      }
    });

    /* ------------- reset helpers ------------ */
    function resetAllCover(){
      dz.removeAllFiles(true);
      previewBox.style.display = 'none';
      coverBox.style.display   = 'none';
      document.querySelector('.polished-dropzone').style.display = 'flex';
      bgFile = null; bgDone = false; toggleFinish();
    }
    function resetAll(){
      step1.classList.remove('d-none'); step2.classList.add('d-none'); pm.style.height = '';
      nameInput.value = ''; nameInput.classList.remove('is-invalid');
      tagify.removeAllTags(); tagifyWrapper.classList.remove('is-invalid-border');
      initIcon(); resetAllCover(); descTxt.value = ''; descCount.textContent = '0';
    }

    /* ------------- footer actions ----------- */
    bgRemoveBtn.onclick = ()=> { if (bgFile) dz.removeFile(bgFile); };
    saveBgBtn.onclick   = ()=> {
      if (!bgDone) {
        document.querySelector('.polished-dropzone').classList.add('is-invalid-border');
        Swal.fire({title:'Upload cover first',icon:'error',customClass:{confirmButton:'btn btn-primary'},buttonsStyling:false});
        return;
      }
      Swal.fire({title:'Community chat created!',icon:'success',customClass:{confirmButton:'btn btn-success'},buttonsStyling:false})
           .then(()=> bgModal.hide());
    };

    // 3rd-modal “Back” goes to Step 2, with smooth swap
    bgBackBtn.onclick = () => {
      bgModal.hide();
      const onFirstModalShown = () => {
        modalEl.removeEventListener('shown.bs.modal', onFirstModalShown);
        swap(step1, step2);
      };
      modalEl.addEventListener('shown.bs.modal', onFirstModalShown, { once: true });
      mainModal.show();
    };

    /* ------ auto-reset on hide/show --------- */
    modalEl.addEventListener('hidden.bs.modal', resetAll);
    bgModalEl.addEventListener('hidden.bs.modal', resetAll);
    modalEl.addEventListener('shown.bs.modal', resetAll);
    bgModalEl.addEventListener('shown.bs.modal', resetAll);
  });
</script>
