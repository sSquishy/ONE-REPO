{% comment %} <!-- Include this style block in your page head or above the modal -->
<style>
  .upload-progress-bar {
    transition: width 0.4s ease;
  }
</style>
<style>
  .upload-item {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 12px;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    background: #f8f9fa;
  }
  .upload-thumbnail {
    width: 80px;
    height: 60px;
    border-radius: 4px;
    overflow: hidden;
    flex-shrink: 0;
  }
  .upload-thumbnail img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  .upload-details {
    flex-grow: 1;
    min-width: 0;
  }
  .upload-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
  }
  .upload-filename {
    font-size: 14px;
    font-weight: 500;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 300px;
  }
  .upload-size {
    font-size: 12px;
    color: #6c757d;
    margin-left: auto;
  }
  .upload-progress-container {
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .upload-progress {
    flex-grow: 1;
    height: 6px;
    background: #e9ecef;
    border-radius: 4px;
    overflow: hidden;
  }
  .upload-progress-bar {
    height: 100%;
    background: #0d6efd;
    transition: width 0.3s ease;
  }
  .upload-percentage {
    font-size: 12px;
    color: #0d6efd;
    min-width: 40px;
    text-align: right;
  }
  .upload-remove {
    color: #dc3545;
    cursor: pointer;
    font-size: 24px;
    line-height: 1;
    margin-left: 10px;
  }
  button:disabled {
    opacity: 0.65;
    cursor: not-allowed;
  }
</style>

<!-- Add Chika Modal -->
<div class="modal fade" id="addChikaModal" tabindex="-1" aria-labelledby="addChikaModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl" style="max-width: 800px;">
    <div class="modal-content p-3 p-md-5">
      <div class="modal-body py-3 py-md-0">
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        <div class="text-center mb-4">
          <h3 class="mb-2">Add Chika</h3>
          <p class="pt-1">Fill in the details and upload an image</p>
        </div>

        <!-- Chika Details -->
        <div class="row g-4">
          <!-- Title (Max 50 words) -->
          <div class="col-12">
            <div class="form-floating form-floating-outline">
              <input
                type="text"
                id="chikaTitle"
                name="chikaTitle"
                class="form-control required-field"
                placeholder="Chika Title"
              />
              <label for="chikaTitle">Title</label>
              <small class="word-counter" id="titleCounter">0/50 words</small>
            </div>
          </div>

          <!-- Start Date -->
          <div class="col-md-6 col-12">
            <div class="form-floating form-floating-outline">
              <input
                type="text"
                class="form-control required-field"
                placeholder="YYYY-MM-DD"
                id="chikaStartDate"
                name="chikaStartDate"
              />
              <label for="chikaStartDate">Start Date</label>
            </div>
          </div>

          <!-- End Date -->
          <div class="col-md-6 col-12">
            <div class="form-floating form-floating-outline">
              <input
                type="text"
                class="form-control required-field"
                placeholder="YYYY-MM-DD"
                id="chikaEndDate"
                name="chikaEndDate"
              />
              <label for="chikaEndDate">End Date</label>
            </div>
          </div>

          <!-- Status Dropdown -->
          <div class="col-12">
            <div class="form-floating form-floating-outline">
              <select id="chikaStatus" name="chikaStatus" class="form-select required-field">
                <option value="" disabled selected>Select Status</option>
                <option value="Active">Active</option>
                <option value="Inactive">Inactive</option>
              </select>
              <label for="chikaStatus">Status</label>
            </div>
          </div>
        </div>
        <br />

        <!-- Image Upload Section -->
        <div class="row">
          <div class="col-12">
            <!-- Dropzone Card -->
            <div class="card mb-4" id="chika-upload-section">
              <h5 class="card-header">Image Upload</h5>
              <div class="card-body">
                <form
                  action="/upload_chika"
                  class="dropzone needsclick"
                  id="chika-dropzone"
                >
                  <div class="dz-message needsclick">
                    Drop image here or click to upload
                    <span class="note needsclick">(Supported formats: JPEG, PNG. Max file size: 5MB)</span>
                  </div>
                  <div class="fallback">
                    <input name="file" type="file" />
                  </div>
                </form>
              </div>
            </div>
            <!-- Image Preview Container -->
            <div id="chika-upload-preview" class="mt-4" style="display: none;">
              <div class="upload-item">
                <div class="upload-thumbnail">
                  <img src="" alt="Preview" id="chika-uploaded-preview" />
                </div>
                <div class="upload-details">
                  <div class="upload-header">
                    <span class="upload-filename" id="chika-uploaded-filename"></span>
                    <span class="upload-size" id="chika-uploaded-size"></span>
                  </div>
                  <div class="upload-progress-container">
                    <div class="upload-progress">
                      <div class="upload-progress-bar" style="width: 0%"></div>
                    </div>
                    <span class="upload-percentage" id="chika-upload-percentage">0%</span>
                    <span class="upload-remove" id="chika-remove-upload">×</span>
                  </div>
                </div>
              </div>
            </div>
            <!-- End Image Preview Container -->
          </div>
        </div>
        <!-- End Image Upload Section -->
      </div>
      <br />

      <!-- Submit and Cancel Buttons -->
      <div class="modal-footer justify-content-center">
        <button type="button" class="btn btn-primary me-3" id="chika-submit-upload">
          Submit
        </button>
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
          Cancel
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Script to initialize Flatpickr and Dropzone, validate fields, and handle submit -->
<script>
document.addEventListener("DOMContentLoaded", function () {
  // Utility to count words
  function countWords(str) {
    return str.trim().split(/\s+/).filter(word => word.length > 0).length;
  }

  // Reference elements
  const submitBtn = document.getElementById("chika-submit-upload");
  const requiredFields = document.querySelectorAll(".required-field");
  const uploadSection = document.getElementById("chika-upload-section");
  const previewContainer = document.getElementById("chika-upload-preview");
  const titleInput = document.getElementById("chikaTitle");
  const titleCounter = document.getElementById("titleCounter");

  // Track the current file & upload status
  let currentChikaFile = null;
  let isFileFullyUploaded = false;

  // Update word counter for Title field
  titleInput.addEventListener("input", function () {
    const words = countWords(this.value);
    titleCounter.textContent = words + "/50 words";
  });

  // Initialize flatpickr for Start Date and End Date
  const startPicker = flatpickr("#chikaStartDate", {
    dateFormat: "Y-m-d",
    onChange: function (selectedDates) {
      endPicker.set("minDate", selectedDates[0] || null);
    }
  });
  const endPicker = flatpickr("#chikaEndDate", {
    dateFormat: "Y-m-d",
    onChange: function (selectedDates) {
      startPicker.set("maxDate", selectedDates[0] || null);
    }
  });

  /**
   * Validate required fields
   * @return { isValid: boolean, missingFields: string[] }
   */
  function validateFields() {
    let isValid = true;
    let missingFields = [];

    requiredFields.forEach(field => {
      let fieldValue = field.value.trim();
      let fieldName = field.parentNode.querySelector("label")?.textContent || field.placeholder;

      if (field.tagName === "SELECT" && fieldValue === "") {
        field.classList.add("is-invalid");
        missingFields.push(fieldName);
        isValid = false;
      } else if (!fieldValue) {
        field.classList.add("is-invalid");
        missingFields.push(fieldName);
        isValid = false;
      } else {
        field.classList.remove("is-invalid");
      }
    });

    // Additional Title words count check (max 50 words)
    if (titleInput.value.trim() && countWords(titleInput.value) > 50) {
      titleInput.classList.add("is-invalid");
      missingFields.push("Title (maximum 50 words)");
      isValid = false;
    } else {
      titleInput.classList.remove("is-invalid");
    }

    // Check file presence & upload completion
    if (!currentChikaFile) {
      uploadSection.classList.add("border", "border-danger");
      missingFields.push("Image Upload");
      isValid = false;
    } else {
      uploadSection.classList.remove("border", "border-danger");
      if (!isFileFullyUploaded) {
        missingFields.push("Image still uploading");
        isValid = false;
      }
    }

    return { isValid, missingFields };
  }

  // Monitor fields in real-time
  requiredFields.forEach(field => {
    field.addEventListener("input", validateFields);
    field.addEventListener("change", validateFields);
  });

  // Initialize Dropzone for image upload
  var chikaDropzone = new Dropzone("#chika-dropzone", {
    url: "/upload_chika",
    maxFiles: 1,
    maxFilesize: 5, // MB
    acceptedFiles: "image/jpeg,image/png",
    addRemoveLinks: false,
    autoProcessQueue: true,
    dictDefaultMessage: "Drop image here or click to upload",
    dictInvalidFileType: "Invalid file type. Only JPEG/PNG allowed.",
    previewTemplate: '<div style="display:none"></div>',
    init: function () {
      this.on("addedfile", function (file) {
        // Hide dropzone area, show preview container
        uploadSection.style.display = "none";
        previewContainer.style.display = "block";

        // Show a preview of the file
        var reader = new FileReader();
        reader.onload = function (e) {
          document.getElementById("chika-uploaded-preview").src = e.target.result;
        };
        reader.readAsDataURL(file);

        // Show filename & size
        document.getElementById("chika-uploaded-filename").textContent = file.name;
        document.getElementById("chika-uploaded-size").textContent =
          (file.size / 1024 / 1024).toFixed(1) + " MB";

        currentChikaFile = file;
        isFileFullyUploaded = false;
        validateFields();
      });

      // Live progress updates
      this.on("uploadprogress", function (file, progress) {
        const progressBar = document.querySelector(".upload-progress-bar");
        const percentage = Math.round(progress);
        progressBar.style.width = percentage + "%";
        document.getElementById("chika-upload-percentage").textContent = percentage + "%";
      });

      // Upload success => file fully uploaded
      this.on("success", function (file, response) {
        const progressBar = document.querySelector(".upload-progress-bar");
        progressBar.style.width = "100%";
        document.getElementById("chika-upload-percentage").textContent = "100%";
        isFileFullyUploaded = true;
        validateFields();
      });

      // Handle upload errors
      this.on("error", function (file, errorMessage) {
        Swal.fire({
          title: "Upload Error",
          text: errorMessage || "There was a problem uploading your image.",
          icon: "error",
          customClass: {
            confirmButton: "btn btn-primary waves-effect waves-light"
          },
          buttonsStyling: false
        });
      });

      // If file is removed
      this.on("removedfile", function () {
        // Show dropzone area, hide preview container
        uploadSection.style.display = "block";
        previewContainer.style.display = "none";
        currentChikaFile = null;
        isFileFullyUploaded = false;
        validateFields();
      });
    }
  });

  // Removing an uploaded file from the preview
  document.getElementById("chika-remove-upload").addEventListener("click", function () {
    if (currentChikaFile) {
      Swal.fire({
        title: "Remove File?",
        text: "Are you sure you want to remove this file?",
        icon: "warning",
        showCancelButton: true,
        confirmButtonText: "Yes, remove it!",
        customClass: {
          confirmButton: "btn btn-primary me-3 waves-effect waves-light",
          cancelButton: "btn btn-outline-secondary waves-effect"
        },
        buttonsStyling: false
      }).then(result => {
        if (result.isConfirmed) {
          chikaDropzone.removeFile(currentChikaFile);
          Swal.fire({
            title: "Removed!",
            text: "The file has been removed.",
            icon: "success",
            customClass: {
              confirmButton: "btn btn-success waves-effect"
            },
            buttonsStyling: false
          });
        }
      });
    }
  });

  // Submit button handler
  submitBtn.addEventListener("click", function () {
    const { isValid, missingFields } = validateFields();

    if (isValid) {
      Swal.fire({
        title: "Are you sure?",
        text: "Do you want to add this chika?",
        icon: "question",
        showCancelButton: true,
        confirmButtonText: "Yes, add it!",
        customClass: {
          confirmButton: "btn btn-primary me-3 waves-effect waves-light",
          cancelButton: "btn btn-outline-secondary waves-effect"
        },
        buttonsStyling: false
      })
      .then(result => {
        if(result.isConfirmed) {
          Swal.fire({
              title: "Saving...",
              text: "Processing data...",
              allowOutsideClick: false,
              didOpen: () => {
                  Swal.showLoading();
              },
              showCancelButton: false,
              confirmButtonText: '',
              customClass: { confirmButton: '', cancelButton: '' },
              buttonsStyling: false
          });

          // Set a timeout to show a warning message if the process takes too long
          let timeout = setTimeout(() => {
              Swal.update({
                  title: 'Saving...',
                  text: 'This is taking longer than expected. Please wait or check your internet connection.',
                  icon: 'warning',
                  showConfirmButton: false,
                  showCancelButton: false,
                  confirmButtonText: '',
                  customClass: { confirmButton: '', cancelButton: '' },
                  buttonsStyling: false,
                  allowOutsideClick: false,
              });
              Swal.showLoading();
          }, 5000); // Change 5000 to any delay you want in milliseconds

            // Set a timeout to show a warning message if the process takes too long
          let timeout2 = setTimeout(() => {
              Swal.close();
              Swal.fire({
                  title: 'Failed to save chika',
                  text: 'Please reload the page and try again.',
                  icon: 'error',
                  customClass: { confirmButton: 'btn btn-danger waves-effect' },
                  buttonsStyling: false
              })
              .then(() => {
                  location.reload();
              })
          }, 30000); // Change 5000 to any delay you want in milliseconds

          let formData = new FormData();
          formData.append("chikaTitle", titleInput.value);
          formData.append("chikaDescription", titleInput.value);
          formData.append("startDate", document.getElementById("chikaStartDate").value);
          formData.append("endDate", document.getElementById("chikaEndDate").value);
          formData.append("status", document.getElementById("chikaStatus").value);
          formData.append("chikaImage", currentChikaFile);
          formData.append("csrfmiddlewaretoken", csrf);

          $.ajax({
            url: addChika,
            type: "POST",
            data: formData,
            processData: false,
            contentType: false,
            success: function (response) {
              clearTimeout(timeout);
              clearTimeout(timeout2);
              Swal.close();

              Swal.fire({
                title: "Success!",
                text: "Chika added successfully.",
                icon: "success",
                customClass: {
                  confirmButton: "btn btn-primary waves-effect waves-light"
                },
                buttonsStyling: false
              }).then(() => {
                // Reset all fields
                titleInput.value = "";
                document.getElementById("chikaStartDate").value = "";
                document.getElementById("chikaEndDate").value = "";
                document.getElementById("chikaStatus").selectedIndex = 0;
                titleCounter.textContent = "0/50 words";
                requiredFields.forEach(field => field.classList.remove("is-invalid"));

                // Reset file upload
                chikaDropzone.removeAllFiles(true);
                currentChikaFile = null;
                isFileFullyUploaded = false;
                uploadSection.style.display = "block";
                previewContainer.style.display = "none";

                // Close modal (assuming jQuery is present)
                $("#addChikaModal").modal("hide");
                // Reload the table
                document.dt_chika.ajax.reload(null, false);
              });
            },
            error: function (xhr, status, error) {
              clearTimeout(timeout);
              clearTimeout(timeout2);
              Swal.close();

              Swal.fire({
                title: "Error!",
                text: "Please complete the following: " + missingFields.join(", "),
                icon: "error",
                customClass: {
                  confirmButton: "btn btn-primary waves-effect waves-light"
                },
                buttonsStyling: false
              });
            }
          })
        }
      });
    } else {
      Swal.fire({
        title: "Error!",
        text: "Please complete the following: " + missingFields.join(", "),
        icon: "error",
        customClass: {
          confirmButton: "btn btn-primary waves-effect waves-light"
        },
        buttonsStyling: false
      });
    }
  });

  // When the modal is closed, reset everything
  $("#addChikaModal").on("hidden.bs.modal", function () {
    chikaDropzone.removeAllFiles(true);
    currentChikaFile = null;
    isFileFullyUploaded = false;
    requiredFields.forEach(field => {
      field.value = "";
      field.classList.remove("is-invalid");
    });
    titleCounter.textContent = "0/50 words";
    uploadSection.style.display = "block";
    previewContainer.style.display = "none";
  });
});
</script> {% endcomment %}


<!-- Include this style block in your page head or above the modal -->
<style>
  .upload-progress-bar {
    transition: width 0.4s ease;
  }
</style>
<style>
  .upload-item {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 12px;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    background: #f8f9fa;
  }
  .upload-thumbnail {
    width: 80px;
    height: 60px;
    border-radius: 4px;
    overflow: hidden;
    flex-shrink: 0;
  }
  .upload-thumbnail img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  .upload-details {
    flex-grow: 1;
    min-width: 0;
  }
  .upload-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
  }
  .upload-filename {
    font-size: 14px;
    font-weight: 500;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 300px;
  }
  .upload-size {
    font-size: 12px;
    color: #6c757d;
    margin-left: auto;
  }
  .upload-progress-container {
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .upload-progress {
    flex-grow: 1;
    height: 6px;
    background: #e9ecef;
    border-radius: 4px;
    overflow: hidden;
  }
  .upload-progress-bar {
    height: 100%;
    background: #0d6efd;
    transition: width 0.3s ease;
  }
  .upload-percentage {
    font-size: 12px;
    color: #0d6efd;
    min-width: 40px;
    text-align: right;
  }
  .upload-remove {
    color: #dc3545;
    cursor: pointer;
    font-size: 24px;
    line-height: 1;
    margin-left: 10px;
  }
  button:disabled {
    opacity: 0.65;
    cursor: not-allowed;
  }
</style>

<!-- Add Chika Modal -->
<div class="modal fade" id="addChikaModal" tabindex="-1" aria-labelledby="addChikaModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl" style="max-width: 800px;">
    <div class="modal-content p-3 p-md-5">
      <div class="modal-body py-3 py-md-0">
        <div class="d-flex justify-content-end">
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="text-center mb-4">
          <h3 class="mb-2">Add Chika</h3>
          <p class="pt-1">Fill in the details and upload an image</p>
        </div>

        <!-- Chika Details -->
        <div class="row g-4">
          <!-- Title (Max 50 characters) -->
          <div class="col-12">
            <div class="form-floating form-floating-outline">
              <input
                type="text"
                id="chikaTitle"
                name="chikaTitle"
                class="form-control required-field"
                placeholder="Chika Title"
              />
              <label for="chikaTitle">Title</label>
              <small class="char-counter" id="titleCounter">0/150 characters</small>
            </div>
          </div>

          <!-- Description (Max 5000 characters) -->
          <div class="col-12">
            <div class="form-floating form-floating-outline">
              <textarea
                id="chikaDescription"
                name="chikaDescription"
                class="form-control required-field"
                placeholder="Chika Description"
                maxlength="5000"
                style="height: 100px;"
              ></textarea>
              <label for="chikaDescription">Description</label>
              <small class="char-counter" id="descriptionCounter">0/5000 characters</small>
            </div>
          </div>

          <!-- Start Date -->
          <div class="col-md-6 col-12">
            <div class="form-floating form-floating-outline">
              <input
                type="text"
                class="form-control required-field"
                placeholder="YYYY-MM-DD"
                id="chikaStartDate"
                name="chikaStartDate"
              />
              <label for="chikaStartDate">Start Date</label>
            </div>
          </div>

          <!-- End Date -->
          <div class="col-md-6 col-12">
            <div class="form-floating form-floating-outline">
              <input
                type="text"
                class="form-control required-field"
                placeholder="YYYY-MM-DD"
                id="chikaEndDate"
                name="chikaEndDate"
              />
              <label for="chikaEndDate">End Date</label>
            </div>
          </div>

          <!-- Status Dropdown -->
          <div class="col-12">
            <div class="form-floating form-floating-outline">
              <select id="chikaStatus" name="chikaStatus" class="form-select required-field">
                <option value="" disabled selected>Select Status</option>
                <option value="Active">Active</option>
                <option value="Inactive">Inactive</option>
              </select>
              <label for="chikaStatus">Status</label>
            </div>
          </div>
        </div>
        <br />

        <!-- Image Upload Section -->
        <div class="row">
          <div class="col-12">
            <!-- Dropzone Card -->
            <div class="card mb-4" id="chika-upload-section">
              <h5 class="card-header">Image Upload</h5>
              <div class="card-body">
                <form
                  action="/upload_chika"
                  class="dropzone needsclick"
                  id="chika-dropzone"
                >
                  <div class="dz-message needsclick">
                    Drop image here or click to upload
                    <span class="note needsclick">(Supported formats: JPEG, PNG. Max file size: 5MB)</span>
                  </div>
                  <div class="fallback">
                    <input name="file" type="file" />
                  </div>
                </form>
              </div>
            </div>
            <!-- Image Preview Container -->
            <div id="chika-upload-preview" class="mt-4" style="display: none;">
              <div class="upload-item">
                <div class="upload-thumbnail">
                  <img src="" alt="Preview" id="chika-uploaded-preview" />
                </div>
                <div class="upload-details">
                  <div class="upload-header">
                    <span class="upload-filename" id="chika-uploaded-filename"></span>
                    <span class="upload-size" id="chika-uploaded-size"></span>
                  </div>
                  <div class="upload-progress-container">
                    <div class="upload-progress">
                      <div class="upload-progress-bar" style="width: 0%"></div>
                    </div>
                    <span class="upload-percentage" id="chika-upload-percentage">0%</span>
                    <span class="upload-remove" id="chika-remove-upload">×</span>
                  </div>
                </div>
              </div>
            </div>
            <!-- End Image Preview Container -->
          </div>
        </div>
        <!-- End Image Upload Section -->
      </div>
      <br />

      <!-- Submit and Cancel Buttons -->
      <div class="modal-footer justify-content-center">
        <button type="button" class="btn btn-primary me-3" id="chika-submit-upload">
          Submit
        </button>
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
          Cancel
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Script to initialize Flatpickr, Dropzone, validate fields, and handle submit -->
<script>
document.addEventListener("DOMContentLoaded", function () {
  // Reference elements
  const submitBtn = document.getElementById("chika-submit-upload");
  const requiredFields = document.querySelectorAll(".required-field");
  const uploadSection = document.getElementById("chika-upload-section");
  const previewContainer = document.getElementById("chika-upload-preview");
  const titleInput = document.getElementById("chikaTitle");
  const titleCounter = document.getElementById("titleCounter");
  const descriptionInput = document.getElementById("chikaDescription");
  const descriptionCounter = document.getElementById("descriptionCounter");

  // Track the current file & upload status
  let currentChikaFile = null;
  let isFileFullyUploaded = false;

  // Update character counter for Title field (max 150 characters)
  titleInput.addEventListener("input", function () {
    const charCount = this.value.length;
    titleCounter.textContent = charCount + "/150 characters";
  });

  // Update character counter for Description field (max 5000 characters)
  descriptionInput.addEventListener("input", function () {
    const charCount = this.value.length;
    descriptionCounter.textContent = charCount + "/5000 characters";
  });

  // Initialize flatpickr for Start Date and End Date
  const startPicker = flatpickr("#chikaStartDate", {
    dateFormat: "Y-m-d",
    onChange: function (selectedDates) {
      endPicker.set("minDate", selectedDates[0] || null);
    }
  });
  const endPicker = flatpickr("#chikaEndDate", {
    dateFormat: "Y-m-d",
    onChange: function (selectedDates) {
      startPicker.set("maxDate", selectedDates[0] || null);
    }
  });

  /**
   * Validate required fields
   * @return { isValid: boolean, missingFields: string[] }
   */
  function validateFields() {
    let isValid = true;
    let missingFields = [];

    requiredFields.forEach(field => {
      let fieldValue = field.value.trim();
      let fieldName = field.parentNode.querySelector("label")?.textContent || field.placeholder;

      if (field.tagName === "SELECT" && fieldValue === "") {
        field.classList.add("is-invalid");
        missingFields.push(fieldName);
        isValid = false;
      } else if (!fieldValue) {
        field.classList.add("is-invalid");
        missingFields.push(fieldName);
        isValid = false;
      } else {
        field.classList.remove("is-invalid");
      }
    });

    // Additional Title characters count check (max 150 characters)
    if (titleInput.value.trim() && titleInput.value.length > 150) {
      titleInput.classList.add("is-invalid");
      missingFields.push("Title (maximum 50 characters)");
      isValid = false;
    } else {
      titleInput.classList.remove("is-invalid");
    }

    // Additional Description characters count check (max 5000 characters)
    if (descriptionInput.value.trim() && descriptionInput.value.length > 5000) {
      descriptionInput.classList.add("is-invalid");
      missingFields.push("Description (maximum 5000 characters)");
      isValid = false;
    } else {
      descriptionInput.classList.remove("is-invalid");
    }

    // Check file presence & upload completion
    if (!currentChikaFile) {
      uploadSection.classList.add("border", "border-danger");
      missingFields.push("Image Upload");
      isValid = false;
    } else {
      uploadSection.classList.remove("border", "border-danger");
      if (!isFileFullyUploaded) {
        missingFields.push("Image still uploading");
        isValid = false;
      }
    }

    return { isValid, missingFields };
  }

  // Monitor fields in real-time
  requiredFields.forEach(field => {
    field.addEventListener("input", validateFields);
    field.addEventListener("change", validateFields);
  });

  // Initialize Dropzone for image upload
  var chikaDropzone = new Dropzone("#chika-dropzone", {
    url: "/upload_chika",
    maxFiles: 1,
    maxFilesize: 5, // MB
    acceptedFiles: "image/jpeg,image/png",
    addRemoveLinks: false,
    autoProcessQueue: true,
    dictDefaultMessage: "Drop image here or click to upload",
    dictInvalidFileType: "Invalid file type. Only JPEG/PNG allowed.",
    previewTemplate: '<div style="display:none"></div>',
    init: function () {
      this.on("addedfile", function (file) {
        // Hide dropzone area, show preview container
        uploadSection.style.display = "none";
        previewContainer.style.display = "block";

        // Show a preview of the file
        var reader = new FileReader();
        reader.onload = function (e) {
          document.getElementById("chika-uploaded-preview").src = e.target.result;
        };
        reader.readAsDataURL(file);

        // Show filename & size
        document.getElementById("chika-uploaded-filename").textContent = file.name;
        document.getElementById("chika-uploaded-size").textContent =
          (file.size / 1024 / 1024).toFixed(1) + " MB";

        currentChikaFile = file;
        isFileFullyUploaded = false;
        validateFields();
      });

      // Live progress updates
      this.on("uploadprogress", function (file, progress) {
        const progressBar = document.querySelector(".upload-progress-bar");
        const percentage = Math.round(progress);
        progressBar.style.width = percentage + "%";
        document.getElementById("chika-upload-percentage").textContent = percentage + "%";
      });

      // Upload success => file fully uploaded
      this.on("success", function (file, response) {
        const progressBar = document.querySelector(".upload-progress-bar");
        progressBar.style.width = "100%";
        document.getElementById("chika-upload-percentage").textContent = "100%";
        isFileFullyUploaded = true;
        validateFields();
      });

      // Handle upload errors
      this.on("error", function (file, errorMessage) {
        Swal.fire({
          title: "Upload Error",
          text: errorMessage || "There was a problem uploading your image.",
          icon: "error",
          customClass: {
            confirmButton: "btn btn-primary waves-effect waves-light"
          },
          buttonsStyling: false
        });
      });

      // If file is removed
      this.on("removedfile", function () {
        // Show dropzone area, hide preview container
        uploadSection.style.display = "block";
        previewContainer.style.display = "none";
        currentChikaFile = null;
        isFileFullyUploaded = false;
        validateFields();
      });
    }
  });

  // Removing an uploaded file from the preview
  document.getElementById("chika-remove-upload").addEventListener("click", function () {
    if (currentChikaFile) {
      Swal.fire({
        title: "Remove File?",
        text: "Are you sure you want to remove this file?",
        icon: "warning",
        showCancelButton: true,
        confirmButtonText: "Yes, remove it!",
        customClass: {
          confirmButton: "btn btn-primary me-3 waves-effect waves-light",
          cancelButton: "btn btn-outline-secondary waves-effect"
        },
        buttonsStyling: false
      }).then(result => {
        if (result.isConfirmed) {
          chikaDropzone.removeFile(currentChikaFile);
          Swal.fire({
            title: "Removed!",
            text: "The file has been removed.",
            icon: "success",
            customClass: {
              confirmButton: "btn btn-success waves-effect"
            },
            buttonsStyling: false
          });
        }
      });
    }
  });

  // Submit button handler
  submitBtn.addEventListener("click", function () {
    const { isValid, missingFields } = validateFields();

    if (isValid) {
      Swal.fire({
        title: "Are you sure?",
        text: "Do you want to add this chika?",
        icon: "question",
        showCancelButton: true,
        confirmButtonText: "Yes, add it!",
        customClass: {
          confirmButton: "btn btn-primary me-3 waves-effect waves-light",
          cancelButton: "btn btn-outline-secondary waves-effect"
        },
        buttonsStyling: false
      })
      .then(result => {
        if(result.isConfirmed) {
          Swal.fire({
              title: "Saving...",
              text: "Processing data...",
              allowOutsideClick: false,
              didOpen: () => {
                  Swal.showLoading();
              },
              showCancelButton: false,
              confirmButtonText: '',
              customClass: { confirmButton: '', cancelButton: '' },
              buttonsStyling: false
          });

          // Set a timeout to show a warning message if the process takes too long
          let timeout = setTimeout(() => {
              Swal.update({
                  title: 'Saving...',
                  text: 'This is taking longer than expected. Please wait or check your internet connection.',
                  icon: 'warning',
                  showConfirmButton: false,
                  showCancelButton: false,
                  confirmButtonText: '',
                  customClass: { confirmButton: '', cancelButton: '' },
                  buttonsStyling: false,
                  allowOutsideClick: false,
              });
              Swal.showLoading();
          }, 5000);

          let timeout2 = setTimeout(() => {
              Swal.close();
              Swal.fire({
                  title: 'Failed to save chika',
                  text: 'Please reload the page and try again.',
                  icon: 'error',
                  customClass: { confirmButton: 'btn btn-danger waves-effect' },
                  buttonsStyling: false
              })
              .then(() => {
                  location.reload();
              })
          }, 30000);

          let formData = new FormData();
          formData.append("chikaTitle", titleInput.value);
          formData.append("chikaDescription", descriptionInput.value);
          formData.append("startDate", document.getElementById("chikaStartDate").value);
          formData.append("endDate", document.getElementById("chikaEndDate").value);
          formData.append("status", document.getElementById("chikaStatus").value);
          formData.append("chikaImage", currentChikaFile);
          formData.append("csrfmiddlewaretoken", csrf);

          $.ajax({
            url: addChika,
            type: "POST",
            data: formData,
            processData: false,
            contentType: false,
            success: function (response) {
              clearTimeout(timeout);
              clearTimeout(timeout2);
              Swal.close();

              Swal.fire({
                title: "Success!",
                text: "Chika added successfully.",
                icon: "success",
                customClass: {
                  confirmButton: "btn btn-primary waves-effect waves-light"
                },
                buttonsStyling: false
              }).then(() => {
                // Reset all fields
                titleInput.value = "";
                descriptionInput.value = "";
                document.getElementById("chikaStartDate").value = "";
                document.getElementById("chikaEndDate").value = "";
                document.getElementById("chikaStatus").selectedIndex = 0;
                titleCounter.textContent = "0/150 characters";
                descriptionCounter.textContent = "0/5000 characters";
                requiredFields.forEach(field => field.classList.remove("is-invalid"));

                // Reset file upload
                chikaDropzone.removeAllFiles(true);
                currentChikaFile = null;
                isFileFullyUploaded = false;
                uploadSection.style.display = "block";
                previewContainer.style.display = "none";

                // Close modal
                $("#addChikaModal").modal("hide");
                // Reload the table
                document.dt_chika.ajax.reload(null, false);
              });
            },
            error: function (xhr, status, error) {
              clearTimeout(timeout);
              clearTimeout(timeout2);
              Swal.close();

              Swal.fire({
                title: "Error!",
                text: "Please complete the following: " + missingFields.join(", "),
                icon: "error",
                customClass: {
                  confirmButton: "btn btn-primary waves-effect waves-light"
                },
                buttonsStyling: false
              });
            }
          });
        }
      });
    } else {
      Swal.fire({
        title: "Error!",
        text: "Please complete the following: " + missingFields.join(", "),
        icon: "error",
        customClass: {
          confirmButton: "btn btn-primary waves-effect waves-light"
        },
        buttonsStyling: false
      });
    }
  });

  // When the modal is closed, reset everything
  $("#addChikaModal").on("hidden.bs.modal", function () {
    chikaDropzone.removeAllFiles(true);
    currentChikaFile = null;
    isFileFullyUploaded = false;
    requiredFields.forEach(field => {
      field.value = "";
      field.classList.remove("is-invalid");
    });
    titleCounter.textContent = "0/150 characters";
    descriptionCounter.textContent = "0/5000 characters";
    uploadSection.style.display = "block";
    previewContainer.style.display = "none";
  });
});
</script>
